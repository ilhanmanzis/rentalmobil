steps:
  # Step 1: Build the Docker image
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/$PROJECT_ID/laravel-app", "."]

  # Step 2: Push the image to Google Container Registry (GCR)
  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/laravel-app"]

  # Step 3: Retrieve .env from Secret Manager
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        echo "Fetching secrets..."
        gcloud secrets versions access latest --secret=laravel-env > .env

  # Step 4: Deploy the Docker image to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "gcloud"
    args:
      - "run"
      - "deploy"
      - "laravel-app"
      - "--image=gcr.io/$PROJECT_ID/laravel-app"
      - "--platform=managed"
      - "--region=asia-southeast2"
      - "--allow-unauthenticated"
      - "--update-env-vars=APP_ENV=production"
      - "--update-env-vars=APP_URL=$_APP_URL"

# Substitutions for customization
substitutions:
  _REGION: "asia-southeast2"
  _SERVICE_NAME: "laravel-app"

options:
  logging: CLOUD_LOGGING_ONLY
